<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkinScan AI - Skin Disease Detection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/dribbble-style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-microscope me-2"></i>SkinScan AI
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/about">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/project">Project</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section animate__animated animate__fadeInDown">
        <div class="container">
            <h1 class="hero-title">AI-Powered Skin Disease Detection</h1>
            <p class="hero-subtitle">Scan your skin, get instant results, and take control of your skin health with AI.</p>
        </div>
    </section>

    <!-- Upload Section -->
    <section class="content-section" id="upload-section">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-6">
                    <div class="upload-card">
                        <h2 class="section-title">
                            <i class="fas fa-image"></i>
                            Upload Your Skin Image
                        </h2>
                        <form id="upload-form" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="image-input" class="form-label">Select one or more images of your skin condition:</label>
                                <input class="form-control" type="file" id="image-input" name="file" accept="image/*" multiple required>
                            </div>
                            <div id="preview-container" class="mb-3"></div>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-search me-2"></i>Analyze
                            </button>
                        </form>
                        <div id="loading" class="mt-4 text-center" style="display:none;">
                            <div class="progress" style="height: 25px;">
                                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%">Analyzing...</div>
                            </div>
                            <div class="mt-2">Analyzing, please wait...</div>
                        </div>
                        <div id="result" class="mt-4" style="display:none;">
                            <div id="result-list"></div>
                        </div>
                        <div id="history-section" class="mt-4">
                            <h4>Previous Predictions</h4>
                            <ul id="history-list" class="list-group mb-2"></ul>
                            <button id="clear-history" class="btn btn-sm btn-outline-danger">Clear History</button>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 d-flex align-items-start">
                    <div id="disease-explanation-card" class="disease-3d-card" style="display:none; min-width:320px; max-width:420px; margin-top:24px;"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- FAQ Section -->
    <section class="faq-section animate__animated animate__zoomIn">
        <div class="container">
            <h2 class="section-title text-white">
                <i class="fas fa-question-circle"></i>
                Frequently Asked Questions
            </h2>
            <div class="row">
                <div class="col-md-6">
                    <div class="faq-item">
                        <div class="faq-question">
                            <i class="fas fa-shield-alt"></i>
                            Is my data secure?
                        </div>
                        <div class="faq-answer">
                            Yes, we take data security seriously. All images are processed securely and never stored permanently. We use industry-standard encryption for data transmission.
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="faq-item">
                        <div class="faq-question">
                            <i class="fas fa-robot"></i>
                            How accurate is the AI?
                        </div>
                        <div class="faq-answer">
                            Our model achieves 95% accuracy on our test dataset. However, this is for educational purposes and should not replace professional medical advice.
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="faq-item">
                        <div class="faq-question">
                            <i class="fas fa-clock"></i>
                            How long does analysis take?
                        </div>
                        <div class="faq-answer">
                            Analysis typically takes 2-5 seconds. The time depends on image size and server load, but results are usually instant.
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="faq-item">
                        <div class="faq-question">
                            <i class="fas fa-image"></i>
                            What image formats are supported?
                        </div>
                        <div class="faq-answer">
                            We support JPG, PNG, and JPEG formats. Images should be clear and well-lit for best results. Maximum file size is 16MB.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-4">
                    <div class="footer-brand">
                        <i class="fas fa-microscope me-2"></i>
                        <span class="fw-bold">SkinScan AI</span>
                    </div>
                    <p class="footer-description">
                        Revolutionizing skin disease detection with cutting-edge artificial intelligence. 
                        Making healthcare more accessible and proactive.
                    </p>
                </div>
                <div class="col-lg-4">
                    <h5 class="footer-title">Quick Links</h5>
                    <ul class="footer-links">
                        <li><a href="/"><i class="fas fa-home me-2"></i>Home</a></li>
                        <li><a href="/about"><i class="fas fa-info-circle me-2"></i>About</a></li>
                        <li><a href="/project"><i class="fas fa-project-diagram me-2"></i>Project</a></li>
                        <li><a href="/contact"><i class="fas fa-envelope me-2"></i>Contact</a></li>
                    </ul>
                </div>
                <div class="col-lg-4">
                    <h5 class="footer-title">Contact Us</h5>
                    <div class="footer-contact">
                        <div class="contact-item">
                            <i class="fas fa-envelope"></i>
                            <a href="mailto:ankur.saini@email.com">ankur.saini@email.com</a>
                        </div>
                        <div class="contact-item">
                            <i class="fas fa-phone"></i>
                            <a href="tel:+919876543210">+91 98765 43210</a>
                        </div>
                        <div class="contact-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>India</span>
                        </div>
                    </div>
                    <div class="social-links mt-3">
                        <a href="#" class="social-link"><i class="fab fa-linkedin-in"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-github"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
            </div>
            <hr class="footer-divider">
            <div class="footer-bottom">
                <p>&copy; 2024 SkinScan AI. All rights reserved.</p>
                <p>Made with <i class="fas fa-heart text-danger"></i> for better healthcare</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script>
    // Progress bar animation
    let progressInterval;
    function startProgressBar() {
        const progressBar = document.getElementById('progress-bar');
        let width = 0;
        progressBar.style.width = '0%';
        progressBar.textContent = 'Analyzing...';
        progressInterval = setInterval(() => {
            if (width < 90) {
                width += Math.random() * 5 + 2; // Simulate progress
                if (width > 90) width = 90;
                progressBar.style.width = width + '%';
            }
        }, 200);
    }
    function finishProgressBar() {
        const progressBar = document.getElementById('progress-bar');
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressBar.textContent = 'Analysis Complete';
        setTimeout(() => {
            progressBar.style.width = '0%';
            progressBar.textContent = 'Analyzing...';
        }, 500);
    }

    // Result history management
    function saveToHistory(result) {
        let history = JSON.parse(localStorage.getItem('predictionHistory') || '[]');
        history.unshift(result); // Add to start
        if (history.length > 10) history = history.slice(0, 10); // Keep last 10
        localStorage.setItem('predictionHistory', JSON.stringify(history));
        renderHistory();
    }
    function renderHistory() {
        const historyList = document.getElementById('history-list');
        let history = JSON.parse(localStorage.getItem('predictionHistory') || '[]');
        historyList.innerHTML = '';
        if (history.length === 0) {
            historyList.innerHTML = '<li class="list-group-item">No previous predictions.</li>';
            return;
        }
        history.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `<strong>${item.prediction}</strong> <span class='text-muted'>(Confidence: ${item.confidence})</span><br><span>${item.description}</span>`;
            historyList.appendChild(li);
        });
    }
    document.getElementById('clear-history').addEventListener('click', function() {
        localStorage.removeItem('predictionHistory');
        renderHistory();
    });
    renderHistory();

    // Image preview & crop
    let croppers = [];
    document.getElementById('image-input').addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        const previewContainer = document.getElementById('preview-container');
        previewContainer.innerHTML = '';
        croppers = [];
        files.forEach((file, idx) => {
            const reader = new FileReader();
            reader.onload = function(ev) {
                const div = document.createElement('div');
                div.className = 'mb-3';
                div.innerHTML = `<div><strong>Image ${idx+1} Preview & Crop:</strong></div><img id="img-preview-${idx}" src="${ev.target.result}" style="max-width:100%; max-height:300px; display:block; margin-bottom:8px;"></div>`;
                previewContainer.appendChild(div);
                const img = div.querySelector('img');
                const cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 });
                croppers.push(cropper);
            };
            reader.readAsDataURL(file);
        });
    });

    // Confidence explanation tooltip
    function addConfidenceTooltip(el) {
        el.innerHTML += ' <i class="fas fa-info-circle text-info" data-bs-toggle="tooltip" title="Confidence indicates how certain the AI is about this prediction. Higher values mean greater certainty."></i>';
        var tooltipTriggerList = [].slice.call(el.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    let lastFullExplanation = '';
    let lastDiseaseName = '';
    let explanationCollapsed = true;

    async function showDiseaseExplanation(diseaseName) {
        const card = document.getElementById('disease-explanation-card');
        card.style.display = 'block';
        card.innerHTML = '<div class="text-center text-secondary"><div class="spinner-border text-primary"></div><div>Loading explanation...</div></div>';
        try {
            const resp = await fetch(`/explain_disease?name=${encodeURIComponent(diseaseName)}`);
            const data = await resp.json();
            if (data.explanation) {
                lastFullExplanation = data.explanation;
                lastDiseaseName = diseaseName;
                explanationCollapsed = true;
                renderExplanationCard();
            } else {
                card.innerHTML = '<div class="text-danger">Could not load explanation.</div>';
            }
        } catch (e) {
            card.innerHTML = '<div class="text-danger">Error loading explanation.</div>';
        }
    }

    function renderExplanationCard() {
        const card = document.getElementById('disease-explanation-card');
        if (!lastFullExplanation) return;
        // Try to split into bullet points (5-6)
        let points = lastFullExplanation.split(/\n[0-9]+[.)]? /).filter(Boolean);
        if (points.length < 2) {
            // fallback: split by newlines or dashes
            points = lastFullExplanation.split(/\n|\r|\u2022|\-/).filter(p => p.trim().length > 0);
        }
        let html = `<h5>${lastDiseaseName.replace(/^[A-Z]+- /, '')} (AI Explanation)</h5><ul>`;
        if (explanationCollapsed && points.length > 6) {
            points.slice(0,6).forEach(pt => { html += `<li>${pt.trim()}</li>`; });
            html += '</ul>';
            html += `<button id="show-more-explanation" class="btn btn-link p-0">Show More</button>`;
        } else {
            points.forEach(pt => { html += `<li>${pt.trim()}</li>`; });
            html += '</ul>';
            if (points.length > 6) html += `<button id="show-more-explanation" class="btn btn-link p-0">Show Less</button>`;
        }
        card.innerHTML = html;
        const btn = document.getElementById('show-more-explanation');
        if (btn) {
            btn.onclick = function() {
                explanationCollapsed = !explanationCollapsed;
                renderExplanationCard();
            };
        }
    }

    // Call showDiseaseExplanation when a disease result is shown (after prediction)
    function tryShowExplanationFromResult(result) {
        // Try to get the most likely disease name
        let disease = null;
        if (result && result.alternatives && result.alternatives.length > 0) {
            disease = result.alternatives[0].prediction;
        } else if (result && result.prediction) {
            disease = result.prediction;
        }
        if (disease) showDiseaseExplanation(disease);
    }

    document.getElementById('upload-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const fileInput = form.querySelector('input[type="file"]');
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');
        const resultList = document.getElementById('result-list');
        if (!fileInput.files.length) return;
        resultDiv.style.display = 'none';
        loadingDiv.style.display = 'block';
        startProgressBar();
        // Get cropped images as blobs
        const croppedImages = await Promise.all(croppers.map(cropper => new Promise(resolve => cropper.getCroppedCanvas().toBlob(resolve, 'image/jpeg'))));
        const formData = new FormData();
        croppedImages.forEach((blob, idx) => {
            formData.append('file', blob, `cropped_${idx}.jpg`);
        });
        try {
            const response = await fetch('/predict', { method: 'POST', body: formData });
            const data = await response.json();
            loadingDiv.style.display = 'none';
            finishProgressBar();
            resultList.innerHTML = '';
            // Support for multiple images and top 2-3 predictions per image
            (Array.isArray(data.results) ? data.results : [data]).forEach((imgResult, imgIdx) => {
                const card = document.createElement('div');
                card.className = 'about-card mb-3';
                let html = `<h5>Image ${imgIdx+1} Results:</h5>`;
                if (imgResult.error) {
                    html += `<div class='text-danger'>${imgResult.error}</div>`;
                } else if (Array.isArray(imgResult.alternatives)) {
                    imgResult.alternatives.slice(0,3).forEach((alt, i) => {
                        html += `<div><strong>${i===0 ? 'Most Likely:' : 'Alternative:'}</strong> ${alt.prediction} <span class='text-muted'>(Confidence: <span class='conf-tooltip'>${alt.confidence}</span>)</span></div>`;
                        html += `<div>${alt.description || ''}</div>`;
                    });
                } else {
                    html += `<div><strong>${imgResult.prediction}</strong> <span class='text-muted'>(Confidence: <span class='conf-tooltip'>${imgResult.confidence}</span>)</span></div>`;
                    html += `<div>${imgResult.description || ''}</div>`;
                }
                card.innerHTML = html;
                resultList.appendChild(card);
                // Add tooltip to all confidence scores
                card.querySelectorAll('.conf-tooltip').forEach(addConfidenceTooltip);
                // Show explanation for the first image's most likely disease
                if (imgIdx === 0) tryShowExplanationFromResult(imgResult);
            });
            resultDiv.style.display = 'block';
        } catch (err) {
            loadingDiv.style.display = 'none';
            finishProgressBar();
            resultList.innerHTML = `<div class='about-card text-danger'>An error occurred while processing your request.</div>`;
            resultDiv.style.display = 'block';
            document.getElementById('disease-explanation-card').style.display = 'none';
        }
    });
    </script>
    <style>
.disease-3d-card {
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37), 0 1.5px 4px rgba(0,0,0,0.08);
    padding: 2rem 1.5rem;
    transform: perspective(600px) rotateY(-8deg) scale(1.03);
    transition: box-shadow 0.3s, transform 0.3s;
    border: 1.5px solid #e3e6f0;
    margin-left: 0.5rem;
}
.disease-3d-card:hover {
    box-shadow: 0 16px 48px 0 rgba(31, 38, 135, 0.45), 0 3px 8px rgba(0,0,0,0.10);
    transform: perspective(600px) rotateY(-2deg) scale(1.05);
}
.disease-3d-card h5 {
    font-weight: 700;
    margin-bottom: 0.75rem;
}
.disease-3d-card ul {
    padding-left: 1.2rem;
    margin-bottom: 0;
}
.content-section {
  padding: 0 !important;
}
/* Remove forced centering and background for upload section */
.upload-card {
  box-shadow: 0 4px 24px rgba(0,0,0,0.07);
  border-radius: 18px;
  background: #fff;
  padding: 2.5rem 2rem;
}
@media (max-width: 991.98px) {
  .disease-3d-card {
    margin-top: 1.5rem !important;
    margin-left: 0 !important;
    min-width: 0 !important;
    max-width: 100% !important;
    width: 100%;
  }
  .upload-card {
    padding: 1.5rem 0.5rem;
  }
}
</style>
</body>
</html>
